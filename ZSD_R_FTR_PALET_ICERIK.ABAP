*&---------------------------------------------------------------------*
*& Report  ZSD_R_FTR_PALET_ICERIK
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT ZSD_R_FTR_PALET_ICERIK.
TABLES : MARA, VEKP,VBRK, MAKT, VEPO,VBFA.

TYPE-POOLS: SLIS.

DATA: FIELDCATALOG TYPE SLIS_T_FIELDCAT_ALV WITH HEADER LINE.
DATA: IT_FIELDCAT  TYPE LVC_T_FCAT,
      WA_FIELDCAT  TYPE LVC_S_FCAT,
      GD_TAB_GROUP TYPE SLIS_T_SP_GROUP_ALV,
      GD_LAYOUT    TYPE LVC_S_LAYO,
      GD_REPID     LIKE SY-REPID.

DATA : BEGIN OF GT_LIST OCCURS 0,

         EXIDV       LIKE VEKP-EXIDV,   "Pallet No
         MATNR       LIKE MARA-MATNR,   "Material No
         MAKTX       LIKE MAKT-MAKTX,   "Description
         TOTAL_KUTU  LIKE VEPO-VEMNG,  "qty (paletteki toplam miktar)
         BRGEW       LIKE MARA-BRGEW,  "Weight (KG)
         TOTAL_BRGEW LIKE VEKP-BRGEW,  "Total Weight (KG)
         VHILM       LIKE VEKP-VHILM,
         VEMNG       LIKE VEPO-VEMNG,   "K.İÇ AD
       END OF GT_LIST.

DATA : BEGIN OF GT_VBRK OCCURS 0,
         VBELN1 LIKE VBRK-VBELN,
         VBELN2 LIKE VBFA-VBELN,
         VBELV  LIKE VBFA-VBELV,
       END OF GT_VBRK.

SELECTION-SCREEN BEGIN OF BLOCK BLK1 WITH FRAME
                                     TITLE TEXT-010.
PARAMETERS PVBELN TYPE VBRK-VBELN OBLIGATORY VALUE CHECK..

SELECTION-SCREEN END OF BLOCK BLK1.

PERFORM GET_DATA.
PERFORM BUILD_FIELDCATALOG.
PERFORM DISPLAY_ALV_REPORT.

FORM GET_DATA .

  SELECT VBR~VBELN AS VBELN1
         VBF~VBELN AS VBELN2
         VBF~VBELV
    FROM VBRK      AS VBR
INNER JOIN VBFA      AS VBF ON VBR~VBELN = VBF~VBELN
    INTO CORRESPONDING FIELDS OF TABLE GT_VBRK
   WHERE VBR~VBELN = PVBELN
     AND VBF~VBTYP_V = 'J'
     AND VBF~VBTYP_N = 'M'
GROUP BY VBR~VBELN VBF~VBELN VBF~VBELV.

  LOOP AT GT_VBRK.

    SELECT PLT~EXIDV
           KTD~MATNR
           MAK~MAKTX
           SUM( KTD~VEMNG ) AS TOTAL_KUTU
           MAR~BRGEW
           MAR~BRGEW        AS TOTAL_BRGEW
           PLT~VHILM
           KTD~VEMNG  "K.İÇ AD
      FROM VEKP AS PLT
INNER JOIN VEPO AS PLD ON PLT~VENUM = PLD~VENUM
INNER JOIN VEKP AS KTU ON PLD~UNVEL = KTU~VENUM
INNER JOIN VEPO AS KTD ON KTU~VENUM = KTD~VENUM
INNER JOIN MARA AS MAR ON KTD~MATNR = MAR~MATNR
 LEFT JOIN MAKT AS MAK ON MAR~MATNR = MAK~MATNR AND MAK~SPRAS = 'EN'
 APPENDING CORRESPONDING FIELDS OF TABLE GT_LIST
     WHERE PLT~VPOBJKEY = GT_VBRK-VBELV
      " AND MAK~SPRAS = 'EN'
  GROUP BY KTD~MATNR MAR~BRGEW PLT~EXIDV
           KTD~VEMNG MAK~MAKTX PLT~VHILM PLD~VEMNG
  ORDER BY KTD~MATNR  PLT~EXIDV.

    LOOP AT GT_LIST.
      GT_LIST-TOTAL_BRGEW = GT_LIST-TOTAL_KUTU * GT_LIST-BRGEW .
      MODIFY GT_LIST.
    ENDLOOP.

  ENDLOOP.

ENDFORM.

FORM BUILD_FIELDCATALOG .

  WA_FIELDCAT-COL_POS    = 1.
  WA_FIELDCAT-FIELDNAME  = 'EXIDV'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-001."'Pallet No'.
  WA_FIELDCAT-OUTPUTLEN   = 22.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR  WA_FIELDCAT.
  WA_FIELDCAT-COL_POS    = 2.
  WA_FIELDCAT-FIELDNAME  = 'MATNR'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-002."'Material No'.
  WA_FIELDCAT-OUTPUTLEN   = 10.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  WA_FIELDCAT-COL_POS    = 3.
  WA_FIELDCAT-FIELDNAME  = 'MAKTX'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-003."'Description'.
  WA_FIELDCAT-OUTPUTLEN   = 10.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  WA_FIELDCAT-COL_POS    = 4.
  WA_FIELDCAT-FIELDNAME  = 'TOTAL_KUTU'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-004."'Qty'.
  WA_FIELDCAT-OUTPUTLEN   = 10.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  WA_FIELDCAT-COL_POS    = 5.
  WA_FIELDCAT-FIELDNAME  = 'BRGEW'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-005."'Weight'.
  WA_FIELDCAT-OUTPUTLEN   = 10.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  WA_FIELDCAT-COL_POS    = 6.
  WA_FIELDCAT-FIELDNAME  = 'TOTAL_BRGEW'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-006."'Total Weight'.
  WA_FIELDCAT-OUTPUTLEN   = 10.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  WA_FIELDCAT-COL_POS    = 7.
  WA_FIELDCAT-FIELDNAME  = 'VHILM'.
  WA_FIELDCAT-SCRTEXT_M  = TEXT-007."'Size of Pallets'.
  WA_FIELDCAT-OUTPUTLEN   = 10.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.

ENDFORM.

FORM DISPLAY_ALV_REPORT .
  GD_REPID = SY-REPID.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
    EXPORTING
      I_CALLBACK_PROGRAM      = GD_REPID
      I_CALLBACK_USER_COMMAND = 'USER_COMMAND'
      IS_LAYOUT_LVC           = GD_LAYOUT
      IT_FIELDCAT_LVC         = IT_FIELDCAT
      I_SAVE                  = 'X'
    TABLES
      T_OUTTAB                = GT_LIST
    EXCEPTIONS
      PROGRAM_ERROR           = 1
      OTHERS                  = 2.
  IF SY-SUBRC <> 0.

  ENDIF.
ENDFORM.
