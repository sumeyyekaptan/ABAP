*&---------------------------------------------------------------------*
*& Report  ZMM_R_MLZ_TEMIN_SURELERI
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT ZMM_R_MLZ_TEMIN_SURELERI.

TABLES : EINA, EINE, EORD, MARA, ZMM_MARA_ADD.

TYPE-POOLS: SLIS.

DATA : LGL          LIKE MARA-MATNR.
DATA : LGZ          LIKE MARA-MATNR.
DATA : LOGO         LIKE ZMM_MARA_ADD-AMB_TEXT.
DATA : MAXM         TYPE STRING.
DATA : MINM         TYPE STRING.
DATA : MAXS         TYPE STRING.
DATA : MINS         TYPE STRING.
DATA : PATH_1       TYPE STRING.
DATA : PATH_2       TYPE STRING.

DATA : LV_TABIX     LIKE SY-TABIX.

DATA : FIELDCATALOG TYPE SLIS_T_FIELDCAT_ALV WITH HEADER LINE.
DATA : IT_FIELDCAT  TYPE LVC_T_FCAT,
       WA_FIELDCAT  TYPE LVC_S_FCAT,
       GD_TAB_GROUP TYPE SLIS_T_SP_GROUP_ALV,
       GD_LAYOUT    TYPE LVC_S_LAYO,
       GD_REPID     LIKE SY-REPID.

DATA : BEGIN OF GT_TEMIN_TIPI OCCURS 0 ,
        MATNR LIKE MARC-MATNR,
        BSTMI LIKE MARC-BSTMI,
        BESKZ LIKE MARC-BESKZ,
        TANIM TYPE STRING,
  END OF GT_TEMIN_TIPI.

DATA : BEGIN OF GT_MAX_MIN OCCURS 0 ,
         MATNR     LIKE EINA-MATNR,
         MAXS      LIKE EINE-APLFZ, "MAX SÜRE
         MINS      LIKE EINE-APLFZ, "MİN SÜRE
         MAXM      LIKE EINE-MINBM, "MAX MİKTAR
         MINM      LIKE EINE-MINBM, "MİN MİKTAR
         MAX_MIN_S TYPE STRING,
         MAX_MIN_M TYPE STRING,
       END OF GT_MAX_MIN.

DATA : BEGIN OF GT_MALZEME OCCURS 0 ,
         MATNR   LIKE EORD-MATNR,
         KUTULU  LIKE ZMM_MARA_ADD-AMB_BRM,
         MATNR_L LIKE ZMM_MARA_ADD-MATNR,
         BESKZ   TYPE STRING,
         BSTMI   LIKE MARC-BSTMI,
         TAPLFZ  LIKE EINE-APLFZ,
         TMINBM  LIKE EINE-MINBM,
         APLFZ   TYPE STRING,
         MINBM   TYPE STRING,
         FLIFN   LIKE EORD-FLIFN,
         LIFNR   LIKE EINA-LIFNR,
         INFNR   LIKE EINA-INFNR,
       END OF GT_MALZEME.

DATA : GT_ANALISTE LIKE TABLE OF GT_MALZEME WITH HEADER LINE.

SELECTION-SCREEN BEGIN OF BLOCK BLOCK1 WITH FRAME
                                       TITLE TEXT-011.
SELECT-OPTIONS: PMATNR  FOR MARA-MATNR.
SELECTION-SCREEN END OF BLOCK BLOCK1.

PERFORM GET_DATA.
PERFORM BUILD_FIELDCATALOG.
PERFORM BUILD_LAYOUT.
PERFORM DISPLAY_ALV_REPORT.

FORM GET_DATA .

  SELECT M~MATNR
         M~BSTMI
         M~BESKZ
    FROM MARC AS M
    INTO CORRESPONDING FIELDS OF TABLE GT_TEMIN_TIPI
   WHERE M~MATNR IN PMATNR.

    LOOP AT GT_TEMIN_TIPI.
        IF GT_TEMIN_TIPI-BESKZ = 'F'.
           GT_TEMIN_TIPI-TANIM = 'Dışarıdan tedarik'.
        ELSEIF GT_TEMIN_TIPI-BESKZ = 'E'.
           GT_TEMIN_TIPI-TANIM = 'Dahili üretim'.
        ELSEIF GT_TEMIN_TIPI-BESKZ = 'X'.
           GT_TEMIN_TIPI-TANIM = 'Her iki tedarik türü de'.
        ELSEIF GT_TEMIN_TIPI-BESKZ = ''.
           GT_TEMIN_TIPI-TANIM = 'Tedarik yok'.
        ENDIF.
        MODIFY GT_TEMIN_TIPI.
    ENDLOOP.

   SELECT MAR~MATNR
          EOR~LIFNR
          EOR~FLIFN
          EIE~APLFZ      AS TAPLFZ
          EIE~MINBM      AS TMINBM
          ZMA~AMB_BRM    AS KUTULU
          EIA~INFNR
     FROM MARA           AS MAR
INNER JOIN ZMM_MARA_ADD  AS ZMA ON ZMA~MATNR = MAR~MATNR
                               AND ZMA~AMB_TEXT <> ''
                            "   AND ZMA~AMB_BRM = 'KTL'
INNER JOIN EORD          AS EOR ON EOR~MATNR = MAR~MATNR
INNER JOIN EINA          AS EIA ON EIA~LIFNR = EOR~LIFNR
                               AND EIA~MATNR = EOR~MATNR
INNER JOIN EINE          AS EIE ON EIA~INFNR = EIE~INFNR
      INTO CORRESPONDING FIELDS OF TABLE GT_MALZEME
     WHERE MAR~MATNR     IN PMATNR.

  LOOP AT GT_MALZEME.

    CALL FUNCTION 'GET_YARIMAMUL_KOD'
      EXPORTING
        MATNR      = GT_MALZEME-MATNR
      IMPORTING
        " MATNR_FIRMA
        MATNR_LOGO = LOGO
        MATNR_LGL  = LGL
        MATNR_LGZ  = LGZ.

    IF LOGO = 'LGL'.
       GT_MALZEME-MATNR_L  = LGL.
    ELSEIF LOGO = 'LGZ'.
       GT_MALZEME-MATNR_L = LGZ.
    ENDIF.
    MODIFY GT_MALZEME.

    CLEAR LGL.
    CLEAR LGZ.

    IF GT_MALZEME-MATNR_L = ''.

      DELETE GT_MALZEME INDEX SY-TABIX.
      MODIFY GT_MALZEME.

    ENDIF.
  ENDLOOP.

  SORT GT_MALZEME BY MATNR ASCENDING.

    SELECT M~MATNR
           MAX( A~APLFZ )  AS MAXS
           MIN( A~APLFZ )  AS MINS
           MAX( A~MINBM )  AS MAXM
           MIN( A~MINBM )  AS MINM
      FROM MARA            AS M
 LEFT JOIN EINA            AS E ON M~MATNR = E~MATNR
INNER JOIN EINE            AS A ON E~INFNR = A~INFNR
      INTO CORRESPONDING FIELDS OF TABLE GT_MAX_MIN
     WHERE M~MATNR    IN PMATNR
  GROUP BY M~MATNR.

      LOOP AT GT_MAX_MIN.
        MAXM = GT_MAX_MIN-MAXM.
        MINM = GT_MAX_MIN-MINM.
        MAXS = GT_MAX_MIN-MAXS.
        MINS = GT_MAX_MIN-MINS.

         CONCATENATE MINM MAXM
                INTO PATH_1
        SEPARATED BY '- '.

         CONCATENATE MINS MAXS
                INTO PATH_2
        SEPARATED BY '- '.

        GT_MAX_MIN-MAX_MIN_M = PATH_1.
        GT_MAX_MIN-MAX_MIN_S = PATH_2.
        MODIFY GT_MAX_MIN.
      ENDLOOP.

      LOOP AT GT_MALZEME.
          READ TABLE GT_MAX_MIN
            WITH KEY MATNR = GT_MALZEME-MATNR
       BINARY SEARCH.
              IF SY-SUBRC = 0.
                 GT_MALZEME-APLFZ = GT_MAX_MIN-MAX_MIN_S.
                 GT_MALZEME-MINBM = GT_MAX_MIN-MAX_MIN_M.
                 MODIFY GT_MALZEME.
              ENDIF.
      ENDLOOP.

     LOOP AT GT_MALZEME.
         READ TABLE GT_ANALISTE
           WITH KEY MATNR = GT_MALZEME-MATNR
      BINARY SEARCH.
             IF SY-SUBRC = 0 .        "MALZEME NUMARALARI EŞİTSE SATIRI GÜNCELLE
                LV_TABIX = SY-TABIX.

                 IF GT_MALZEME-FLIFN = 'X'.  "SATICI TİKİ DOLUYSA YANI BU SATIRDAKİ ANA TEDARİKÇİ
                    "GT_ANALISTE-BESKZ  = GT_MALZEME-BESKZ.
                    GT_ANALISTE-TAPLFZ = GT_MALZEME-TAPLFZ.
                    GT_ANALISTE-TMINBM = GT_MALZEME-TMINBM.
                    GT_ANALISTE-APLFZ  = GT_MALZEME-APLFZ.
                    GT_ANALISTE-MINBM  = GT_MALZEME-MINBM.
                    "GT_ANALISTE-BSTMI  = GT_MALZEME-BSTMI.
                    GT_ANALISTE-FLIFN  = GT_MALZEME-FLIFN.
                  ELSEIF GT_MALZEME-FLIFN = ''. "SATICI TİKİ BOŞSA YANİ ANA TEDARİKÇİ YOKSA
                    GT_ANALISTE-TAPLFZ = ''.
                    GT_ANALISTE-TMINBM = ''.
                  ENDIF.
                  MODIFY GT_ANALISTE INDEX LV_TABIX.
              ELSE. " MALZEME NUMARALARI EŞİT DEĞİLSE SATIRI ANALİSTEYE EKLE
                MOVE-CORRESPONDING GT_MALZEME TO GT_ANALISTE.
                APPEND GT_ANALISTE.
              ENDIF.
      ENDLOOP.

LOOP AT GT_ANALISTE.

  READ TABLE GT_TEMIN_TIPI
  WITH KEY MATNR = GT_ANALISTE-MATNR
  BINARY SEARCH.
  IF SY-SUBRC = 0.

    GT_ANALISTE-BSTMI = GT_TEMIN_TIPI-BSTMI.
    GT_ANALISTE-BESKZ = GT_TEMIN_TIPI-TANIM.
    MODIFY GT_ANALISTE.
  ENDIF.

ENDLOOP.

ENDFORM.

FORM BUILD_FIELDCATALOG .
  DATA LV_COLPOS TYPE I .

  DEFINE ADD_FCTALOG .

    WA_FIELDCAT-FIELDNAME   = &1 .
    WA_FIELDCAT-SCRTEXT_M   = &2.
    FIELDCATALOG-OUTPUTLEN  = 20.
    WA_FIELDCAT-COL_POS     = lv_colpos .
    lv_colpos = lv_colpos + 1 .
    APPEND WA_FIELDCAT TO IT_FIELDCAT.
    CLEAR  WA_FIELDCAT.
  END-OF-DEFINITION.

  "** MAKRO ILE FIELD CATALOG YANI ALV DÜZENI OLUŞTURULUR.
  ADD_FCTALOG   'MATNR'        'Sampa Kodu' .
  ADD_FCTALOG   'BESKZ'        'Temin Tipi'  .
  ADD_FCTALOG   'TAPLFZ'       'Ana Ted Temin Süresi'  .
  ADD_FCTALOG   'TMINBM'       'Ana Ted Satınalma Miktarı'  .
  ADD_FCTALOG   'APLFZ'        'Ted Temin Süresi'  .
  ADD_FCTALOG   'MINBM'        'Ted Min Miktarlar' .
  ADD_FCTALOG   'BSTMI'        'Min Üretim Miktarı'  .

ENDFORM.                    " BUILD_FIELDCATALOG

FORM BUILD_LAYOUT .

  GD_LAYOUT-STYLEFNAME = 'FIELD_STYLE'.
  GD_LAYOUT-ZEBRA      = 'X'.
  GD_LAYOUT-CWIDTH_OPT = 'X'.

ENDFORM.                    " BUILD_LAYOUT

FORM DISPLAY_ALV_REPORT .
  GD_REPID = SY-REPID.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
    EXPORTING
      I_CALLBACK_PROGRAM      = GD_REPID
      I_CALLBACK_USER_COMMAND = 'USER_COMMAND'
      IS_LAYOUT_LVC           = GD_LAYOUT
      IT_FIELDCAT_LVC         = IT_FIELDCAT
      I_SAVE                  = 'X'
    TABLES
      T_OUTTAB                = GT_ANALISTE
    EXCEPTIONS
      PROGRAM_ERROR           = 1
      OTHERS                  = 2.

ENDFORM.                    " DISPLAY_ALV_REPORT
