*&---------------------------------------------------------------------*
*& Report  ZMM_R_SANAL_PARTI
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT ZMM_R_SANAL_PARTI.

TABLES : MARA,MCHA,MARC.

TYPE-POOLS: SLIS.

DATA: FIELDCATALOG TYPE SLIS_T_FIELDCAT_ALV WITH HEADER LINE.

DATA: IT_FIELDCAT  TYPE LVC_T_FCAT,
      WA_FIELDCAT  TYPE LVC_S_FCAT,
      GD_TAB_GROUP TYPE SLIS_T_SP_GROUP_ALV,
      GD_LAYOUT    TYPE LVC_S_LAYO,
      GD_REPID     LIKE SY-REPID.

DATA: IT_FIELDCAT2  TYPE LVC_T_FCAT,
      WA_FIELDCAT2  TYPE LVC_S_FCAT,
      GD_TAB_GROUP2 TYPE SLIS_T_SP_GROUP_ALV,
      GD_LAYOUT2    TYPE LVC_S_LAYO,
      GD_REPID2     LIKE SY-REPID.

DATA : BEGIN OF GT_SANAL OCCURS 0 ,
         WERKS LIKE MARC-WERKS,
         MATNR LIKE MARA-MATNR,
         CHARG LIKE MCHA-CHARG,
         ERNAM LIKE MCHA-ERNAM,
         ERSDA LIKE MCHA-ERSDA,
       END OF GT_SANAL.

SELECTION-SCREEN BEGIN OF BLOCK BLK1 WITH FRAME
                                     TITLE TEXT-001.

PARAMETERS    : PWERKS TYPE MARC-WERKS OBLIGATORY VALUE CHECK.
SELECT-OPTIONS: PMATNR FOR MARA-MATNR .


PARAMETERS: PLCKCHRG AS CHECKBOX DEFAULT 'X'.

SELECTION-SCREEN END OF BLOCK BLK1.

PERFORM GET_DATA.
PERFORM BUILD_FIELDCATALOG.
PERFORM BUILD_LAYOUT.
PERFORM DISPLAY_ALV_REPORT.

FORM GET_DATA .

*Eksik Sanal Partiler SQL
  " ***********************************************************************************
  IF PLCKCHRG = 'X'.
    " ***********************************************************************************

    SELECT MAC~WERKS,
           MAR~MATNR
      FROM MARA         AS MAR
INNER JOIN MARC         AS MAC ON MAR~MATNR = MAC~MATNR
INNER JOIN ZMM_MARA_ADD AS MAD ON MAR~MATNR = MAD~MATNR
 LEFT JOIN MCHA         AS MCH ON MAR~MATNR = MCH~MATNR
      INTO CORRESPONDING FIELDS OF TABLE @GT_SANAL
     WHERE MAD~SANAL_PARTI = 'X'
       AND MAC~WERKS = @PWERKS
       AND MAR~MATNR IN @PMATNR
       AND MCH~CHARG IS NULL
      AND ( MCH~CHARG IS NULL OR MCH~CHARG NOT LIKE 'D%' ).

    " ***********************************************************************************

*Mevcut Sanal Partiler

  ELSE.

    SELECT MAC~WERKS
           MAR~MATNR
           MCH~CHARG
           MCH~ERNAM
           MCH~ERSDA
      FROM MARA         AS MAR
INNER JOIN MARC         AS MAC ON MAR~MATNR = MAC~MATNR
INNER JOIN ZMM_MARA_ADD AS MAD ON MAR~MATNR = MAD~MATNR
INNER JOIN MCHA         AS MCH ON MAR~MATNR = MCH~MATNR
      INTO CORRESPONDING FIELDS OF TABLE GT_SANAL
     WHERE MCH~CHARG LIKE 'D%'
       AND MAC~WERKS = PWERKS
       AND MAR~MATNR IN PMATNR.

  ENDIF.

  " ***********************************************************************************
ENDFORM.

FORM BUILD_FIELDCATALOG .

  WA_FIELDCAT-FIELDNAME   = 'WERKS'.
  WA_FIELDCAT-SCRTEXT_M   = 'ÜRETİM YERİ'."text-001.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT-COL_POS     = 1.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR  WA_FIELDCAT.

  WA_FIELDCAT-FIELDNAME   = 'MATNR'.
  WA_FIELDCAT-SCRTEXT_M   = 'MALZEME NO'."text-002.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT-COL_POS     = 2.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR  WA_FIELDCAT.

  WA_FIELDCAT-FIELDNAME   = 'CHARG'.
  WA_FIELDCAT-SCRTEXT_M   = 'PARTİ NO'."text-003.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT-COL_POS     = 3.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR  WA_FIELDCAT.

  WA_FIELDCAT-FIELDNAME   = 'ERNAM'.
  WA_FIELDCAT-SCRTEXT_M   = 'KULLANICI'."text-003.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT-COL_POS     = 3.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR  WA_FIELDCAT.

  WA_FIELDCAT-FIELDNAME   = 'ERSDA'.
  WA_FIELDCAT-SCRTEXT_M   = 'TARİH'."text-003.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT-COL_POS     = 3.
  APPEND WA_FIELDCAT TO IT_FIELDCAT.
  CLEAR  WA_FIELDCAT.

  WA_FIELDCAT2-FIELDNAME   = 'WERKS'.
  WA_FIELDCAT2-SCRTEXT_M   = 'ÜRETİM YERİ'."text-001.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT2-COL_POS     = 1.
  APPEND WA_FIELDCAT2 TO IT_FIELDCAT2.
  CLEAR  WA_FIELDCAT2.

  WA_FIELDCAT-FIELDNAME   = 'MATNR'.
  WA_FIELDCAT-SCRTEXT_M   = 'MALZEME NO'."text-002.
  FIELDCATALOG-OUTPUTLEN   = 10.
  WA_FIELDCAT-COL_POS     = 2.
  APPEND WA_FIELDCAT TO IT_FIELDCAT2.
  CLEAR  WA_FIELDCAT.

ENDFORM.

FORM BUILD_LAYOUT .

  GD_LAYOUT-STYLEFNAME = 'FIELD_STYLE'.
  GD_LAYOUT-ZEBRA      = 'X'.
  GD_LAYOUT-CWIDTH_OPT = 'X'.

ENDFORM.

FORM DISPLAY_ALV_REPORT .
  GD_REPID = SY-REPID.

  IF PLCKCHRG = ''.

    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
      EXPORTING
        I_CALLBACK_PROGRAM      = GD_REPID
        I_CALLBACK_USER_COMMAND = 'USER_COMMAND'
        IS_LAYOUT_LVC           = GD_LAYOUT
        IT_FIELDCAT_LVC         = IT_FIELDCAT
        I_SAVE                  = 'X'
      TABLES
        T_OUTTAB                = GT_SANAL
      EXCEPTIONS
        PROGRAM_ERROR           = 1
        OTHERS                  = 2.
    IF SY-SUBRC <> 0.

    ENDIF.
  ELSE.

    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
      EXPORTING
        I_CALLBACK_PROGRAM      = GD_REPID
        I_CALLBACK_USER_COMMAND = 'USER_COMMAND'
        IS_LAYOUT_LVC           = GD_LAYOUT
        IT_FIELDCAT_LVC         = IT_FIELDCAT2
        I_SAVE                  = 'X'
      TABLES
        T_OUTTAB                = GT_SANAL
      EXCEPTIONS
        PROGRAM_ERROR           = 1
        OTHERS                  = 2.
    IF SY-SUBRC <> 0.

    ENDIF.

  ENDIF.


ENDFORM.
