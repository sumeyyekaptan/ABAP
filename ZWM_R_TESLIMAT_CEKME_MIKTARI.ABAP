*&---------------------------------------------------------------------*
*& Report  ZWM_R_TESLIMAT_CEKME_MIKTARI
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT ZWM_R_TESLIMAT_CEKME_MIKTARI.

TABLES : ZWM_T_SEVK_EMRI, "Teslimata ilişkin sevk emri bilgileri
         LIPS,
         ZWM_T_PALETONERI,
         VBFA ,
         ZSD_ORDERS,
         ZWM_T_PICKING,
         zsd_t_t006,
         zwm_s_teslimat_durumu. "Teslimat çekme tablosu

TYPE-POOLS: SLIS.

DATA : FIELDCATALOG TYPE SLIS_T_FIELDCAT_ALV WITH HEADER LINE.
DATA : IT_FIELDCAT  TYPE LVC_T_FCAT,
       WA_FIELDCAT  TYPE LVC_S_FCAT,
       GD_TAB_GROUP TYPE SLIS_T_SP_GROUP_ALV,
       GD_LAYOUT    TYPE LVC_S_LAYO,
       GD_REPID     LIKE SY-REPID.

*********************TESLİMAT ÖNERİ TABLOSU*************************

DATA : BEGIN OF GT_TESLIMAT OCCURS 0 ,
         VBELN     LIKE LIPS-VBELN,
         SEVNO     LIKE ZSD_ORDERS-SEVNO,
         KUNNR     LIKE ZSD_ORDERS-KUNNR,
         STOK_KODU LIKE LIPS-MATNR,                  "-STOK KOD
         MAKTX     LIKE MAKT-MAKTX,                  "ÜRÜN ADI
         MIKTAR    LIKE LIPS-LFIMG,                  "TESLİMAT MİKTARI
         CEKILEN   LIKE VBFA-RFMNG,      "ÇEKİLEN MİKTAR
         FARK      LIKE VBFA-RFMNG,      "FARK
         EXIDV     LIKE VBFA-RFMNG,      "PALETLEN ADET
       END OF GT_TESLIMAT.

*********************KUTU-PALET BİLGİSİ*************************

DATA : BEGIN OF GT_PICKING OCCURS 0 ,
         VBELN LIKE ZWM_T_PICKING-VBELN_VL,
         MATNR LIKE VEPO-MATNR,
         VEMNG LIKE VBFA-RFMNG,
       END OF GT_PICKING.

*********************TESLİMAT MİKTARI**********************************

DATA : BEGIN OF LT_CEKILEN OCCURS 0 ,
         VBELN       LIKE LIPS-VBELN,
         MATNR       LIKE LIPS-MATNR,
         OKUNAN      LIKE VBFA-RFMNG,
       END OF LT_CEKILEN.

DATA : BEGIN OF LT_GERICEKILEN OCCURS 0 ,
         VBELN  LIKE LIPS-VBELN,
         MATNR  LIKE LIPS-MATNR,
         OKUNAN LIKE VBFA-RFMNG,
       END OF LT_GERICEKILEN.

DATA : BEGIN OF LT_MAKT OCCURS 0 ,
         MAKTX  LIKE MAKT-MATNR,
         MATNR  LIKE MAKT-MAKTX,
       END OF LT_MAKT.

SELECTION-SCREEN BEGIN OF BLOCK BLOCK1 WITH FRAME
                                       TITLE TEXT-011.
SELECT-OPTIONS : PWERKS2 FOR ZSD_ORDERS-WERKS2.
SELECT-OPTIONS : PLGORT FOR LIPS-LGORT.
SELECT-OPTIONS : PSEVNO for zsd_t_t006-sevno.
SELECT-OPTIONS : pkunnr  FOR zwm_s_teslimat_durumu-kunnr.
SELECT-OPTIONS : PVBELN FOR ZWM_T_PICKING-VBELN_VL .

SELECTION-SCREEN END OF BLOCK BLOCK1.

REFRESH GT_TESLIMAT.
REFRESH GT_PICKING.
REFRESH LT_CEKILEN.
REFRESH LT_GERICEKILEN.

PERFORM GET_DATA.
PERFORM BUILD_FIELDCATALOG.
PERFORM BUILD_LAYOUT.
PERFORM DISPLAY_ALV_REPORT.

FORM GET_DATA .

  SELECT M~MAKTX M~MATNR
    FROM MAKT AS M
   INTO TABLE LT_MAKT
   WHERE M~SPRAS = 'TR'.

  " teslimat miktarları bulunuyor

    SELECT L~VBELN
           Z~KUNNR
           Z~SEVNO
           L~MATNR         AS STOK_KODU
           SUM( L~LFIMG )  AS MIKTAR
      FROM LIPS            AS L
INNER JOIN VBFA            AS V ON V~VBELN = L~VBELN
                               AND V~POSNN = L~POSNR
INNER JOIN ZSD_ORDERS      AS Z ON Z~VBELN = V~VBELV
                                AND Z~OPENCLOSE = '1'
                                AND Z~POSNR = V~POSNV
      INTO CORRESPONDING FIELDS OF TABLE GT_TESLIMAT
     WHERE L~VBELN IN PVBELN
       AND Z~WERKS2 IN PWERKS2
       AND L~LGORT IN PLGORT
       AND Z~KUNNR IN PKUNNR
       AND Z~SEVNO IN PSEVNO
  GROUP BY L~MATNR L~VBELN
           Z~KUNNR Z~SEVNO.

  "teslimat kalemi için toplam çekme miktarı
    SELECT LIPS~VBELN LIPS~MATNR SUM( VBFA~RFMNG ) AS OKUNAN
      INTO CORRESPONDING FIELDS OF TABLE LT_CEKILEN
      FROM VBFA
INNER JOIN LIPS ON LIPS~VBELN = VBFA~VBELV
               AND LIPS~POSNR = VBFA~POSNV
INNER JOIN ZSD_ORDERS      AS Z ON Z~VBELN = VBFA~VBELV
                                AND Z~OPENCLOSE = '1'
                                AND Z~POSNR = VBFA~POSNV
     WHERE VBFA~VBELV   IN PVBELN AND
           VBFA~VBTYP_N = 'Q'     AND
           VBFA~TAQUI   = 'X'     AND
           Z~WERKS2   IN PWERKS2  AND
           LIPS~LGORT IN PLGORT   AND
           Z~KUNNR    IN PKUNNR   AND
           Z~SEVNO    IN PSEVNO   AND
           VBFA~PLMIN NE '-'
  GROUP BY LIPS~VBELN LIPS~MATNR.

 " TESLIMAT KALEMI IÇIN ÇEKME IPTALI YAPILAN MIKTAR
     SELECT LIPS~VBELN LIPS~MATNR SUM( VBFA~RFMNG ) AS OKUNAN
       INTO CORRESPONDING FIELDS OF TABLE LT_GERICEKILEN
       FROM VBFA
 INNER JOIN LIPS ON LIPS~VBELN = VBFA~VBELV
                AND LIPS~POSNR = VBFA~POSNV
 INNER JOIN ZSD_ORDERS      AS Z ON Z~VBELN = VBFA~VBELV
                                AND Z~OPENCLOSE = '1'
                                AND Z~POSNR = VBFA~POSNV
      WHERE VBFA~VBELV   IN PVBELN   AND
            VBFA~VBTYP_N = 'Q'      AND
            VBFA~TAQUI   = 'X'      AND
            Z~WERKS2   IN PWERKS2  AND
            LIPS~LGORT IN PLGORT   AND
            Z~KUNNR    IN PKUNNR   AND
            Z~SEVNO    IN PSEVNO   AND
            VBFA~PLMIN   = '-'
   GROUP BY LIPS~VBELN LIPS~MATNR.

  SORT LT_CEKILEN     BY MATNR ASCENDING.
  SORT LT_GERICEKILEN BY MATNR ASCENDING.
  SORT GT_TESLIMAT    BY vbeln ASCENDING.
  SORT LT_MAKT    BY MATNR ASCENDING.

 LOOP AT LT_CEKILEN.

   READ TABLE LT_GERICEKILEN WITH KEY VBELN = LT_CEKILEN-VBELN
                                      MATNR = LT_CEKILEN-MATNR
                                      BINARY SEARCH.
    IF SY-SUBRC = 0.
     LT_CEKILEN-OKUNAN = LT_CEKILEN-OKUNAN - LT_GERICEKILEN-OKUNAN.
    ENDIF.
    MODIFY LT_CEKILEN.
 ENDLOOP.

    SELECT P~VBELN_VL     AS VBELN
           K~MATNR
           SUM( K~VEMNG ) AS VEMNG
      INTO CORRESPONDING FIELDS OF TABLE  GT_PICKING
      FROM ZWM_T_PICKING  AS P
INNER JOIN VEKP           AS V ON V~EXIDV = P~EXIDV
INNER JOIN VEPO           AS M ON V~VENUM = M~VENUM
INNER JOIN VEPO           AS K ON M~UNVEL = K~VENUM
     WHERE VBELN_VL = PVBELN
  GROUP BY P~VBELN_VL K~MATNR.

  LOOP AT GT_TESLIMAT.

    READ TABLE GT_PICKING WITH KEY MATNR = GT_TESLIMAT-STOK_KODU
    BINARY SEARCH.
    IF SY-SUBRC = 0.
      GT_TESLIMAT-EXIDV = GT_PICKING-VEMNG.
      MODIFY GT_TESLIMAT.
    ENDIF.

    READ TABLE LT_CEKILEN WITH KEY MATNR = GT_TESLIMAT-STOK_KODU
    BINARY SEARCH.
    IF SY-SUBRC = 0.
      GT_TESLIMAT-CEKILEN = LT_CEKILEN-OKUNAN.
      MODIFY GT_TESLIMAT.
    ENDIF.
    GT_TESLIMAT-FARK = GT_TESLIMAT-MIKTAR - GT_TESLIMAT-CEKILEN.
    MODIFY GT_TESLIMAT.

    READ TABLE LT_MAKT WITH KEY MATNR = GT_TESLIMAT-STOK_KODU
    BINARY SEARCH.
    IF SY-SUBRC = 0.
      GT_TESLIMAT-MAKTX = LT_MAKT-MAKTX.
      MODIFY GT_TESLIMAT.
    ENDIF.
  ENDLOOP.

ENDFORM.

FORM BUILD_FIELDCATALOG .
  DATA LV_COLPOS TYPE I .
  DEFINE ADD_FCTALOG .
    WA_FIELDCAT-FIELDNAME   = &1 .        "alan adı
    WA_FIELDCAT-SCRTEXT_M   = &2.         "alanın başlığı
    WA_FIELDCAT-OUTPUTLEN   = '20'.       "alan genişliği 20
   " WA_FIELDCAT-KEY         = 'X'.        "renk mavi
    WA_FIELDCAT-COL_POS     = lv_colpos . "rapordaki sıra
    lv_colpos = lv_colpos + 1 .
    APPEND WA_FIELDCAT TO IT_FIELDCAT.
    CLEAR  WA_FIELDCAT.
  END-OF-DEFINITION.

  "** MAKRO ILE FIELD CATALOG YANI ALV DÜZENI OLUŞTURULUR.
  ADD_FCTALOG   'VBELN'        TEXT-007.
  ADD_FCTALOG   'STOK_KODU'    TEXT-001.
  ADD_FCTALOG   'MAKTX'        TEXT-002.
  ADD_FCTALOG   'MIKTAR'       TEXT-003.
  ADD_FCTALOG   'CEKILEN'      TEXT-004.
  ADD_FCTALOG   'FARK'         TEXT-005.
  ADD_FCTALOG   'EXIDV'        TEXT-006.
  ADD_FCTALOG   'KUNNR'        TEXT-008.
  ADD_FCTALOG   'SEVNO'        TEXT-009.

ENDFORM.                    " BUILD_FIELDCATALOG

FORM BUILD_LAYOUT .
  GD_LAYOUT-STYLEFNAME = 'FIELD_STYLE'.
  GD_LAYOUT-ZEBRA      = 'X'.
  GD_LAYOUT-CWIDTH_OPT = 'X'.
ENDFORM.                    " BUILD_LAYOUT

 FORM DISPLAY_ALV_REPORT .
  GD_REPID = SY-REPID.
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
    EXPORTING
      I_CALLBACK_PROGRAM      = GD_REPID
      I_CALLBACK_USER_COMMAND = 'USER_COMMAND'
      IS_LAYOUT_LVC           = GD_LAYOUT
      IT_FIELDCAT_LVC         = IT_FIELDCAT
      I_SAVE                  = 'X'
    TABLES
      T_OUTTAB                = GT_TESLIMAT
    EXCEPTIONS
      PROGRAM_ERROR           = 1
      OTHERS                  = 2.
ENDFORM.                    " DISPLAY_ALV_REPORT
